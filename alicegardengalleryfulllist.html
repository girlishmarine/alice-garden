<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>çˆ±ä¸½ä¸åº­é™¢ Â· Gallery</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;500;700&display=swap" rel="stylesheet">
<style>
  :root{--primary:#c689d8;--bg:#fdf6f0;--text:#5b3e6d;}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Noto Sans SC',sans-serif;background:linear-gradient(135deg,#fdf6f0 0%,#e6f0fa 50%,#f0e6fa 100%);background-attachment:fixed;color:var(--text);min-height:100vh;overflow-x:hidden;position:relative;}
  #particles{position:fixed;inset:0;z-index:-1;}
  h1{text-align:center;padding:30px 20px 10px;font-size:2.8em;color:transparent;background:linear-gradient(90deg,#b284d1,#8f6ab8);-webkit-background-clip:text;background-clip:text;text-shadow:0 2px 10px rgba(139,105,181,0.3);}
  .subtitle{text-align:center;margin-bottom:20px;color:#9a7bb0;font-weight:300;}
  .tabs{display:flex;justify-content:center;flex-wrap:wrap;gap:12px;padding:0 20px;margin-bottom:25px;}
  .tab{padding:10px 20px;background:rgba(255,255,255,0.7);backdrop-filter:blur(10px);border-radius:30px;cursor:pointer;transition:all .3s;font-weight:500;box-shadow:0 4px 15px rgba(0,0,0,.1);}
  .tab:hover{transform:translateY(-3px);}
  .tab.active{background:var(--primary);color:white;box-shadow:0 8px 25px rgba(198,137,216,.4);}
  #gallery{
    column-count:2;
    column-gap:20px;
    padding:0 20px;
    max-width:1600px;
    margin:0 auto;
  }
  @media(min-width:768px){#gallery{column-count:3;}}
  @media(min-width:1024px){#gallery{column-count:4;}}
  @media(min-width:1400px){#gallery{column-count:5;}}
  .card{
    display:inline-block;
    width:100%;
    margin-bottom:20px;
    background:white;
    border-radius:18px;
    overflow:hidden;
    box-shadow:0 8px 25px rgba(0,0,0,.12);
    transition:all .4s cubic-bezier(0.175,0.885,0.32,1.1);
    break-inside:avoid;
    cursor:pointer;
  }
  .card:hover{
    transform:translateY(-12px) scale(1.02);
    box-shadow:0 20px 40px rgba(139,105,181,.25);
  }
  .card img{
    width:100%;
    height:auto;
    display:block;
    background:#f0e8f5;
  }
  .admin-bar{position:fixed;bottom:20px;right:20px;z-index:100;}
  .admin-btn{padding:12px 20px;background:rgba(139,105,181,0.9);color:white;border:none;border-radius:30px;cursor:pointer;backdrop-filter:blur(10px);box-shadow:0 8px 25px rgba(0,0,0,0.3);font-weight:bold;}
  .stats{text-align:center;margin:20px 0 30px;color:#9a7bb0;font-size:14px;}
  #overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);backdrop-filter:blur(15px);z-index:999;justify-content:center;align-items:center;padding:20px;cursor:pointer;flex-direction:column;gap:15px;}
  #drivePreview{width:94vw;height:94vh;border:none;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.8);}
  .close-btn{position:absolute;top:20px;right:30px;width:50px;height:50px;background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;color:white;cursor:pointer;z-index:1000;transition:all .3s;}
  .close-btn:hover{background:rgba(255,255,255,0.3);transform:scale(1.1);}

  /* æ–°å¢ R18 è§£é”æŒ‰é’® */
  #unlockR18Btn{
    position:fixed;bottom:20px;left:20px;z-index:100;
    padding:14px 28px;background:linear-gradient(135deg,#e040a0,#c689d8);
    color:white;border:none;border-radius:30px;cursor:pointer;
    backdrop-filter:blur(10px);box-shadow:0 8px 30px rgba(199,64,160,0.5);
    font-weight:bold;font-size:15px;letter-spacing:1px;
    transition:all .3s;
  }
  #unlockR18Btn:hover{transform:translateY(-4px);box-shadow:0 12px 40px rgba(199,64,160,0.6);}
  #unlockR18Btn.unlocked{background:#8f6ab8;cursor:default;}

  /* å¯†ç å¼¹çª— */
  #r18Modal{
    display:none;position:fixed;inset:0;background:rgba(0,0,0,0.92);backdrop-filter:blur(12px);
    z-index:9999;justify-content:center;align-items:center;
  }
  .modal-content{
    background:linear-gradient(135deg,#fdf6f0,#f0e8f8);padding:40px 50px;border-radius:24px;
    box-shadow:0 20px 60px rgba(139,105,181,0.6);text-align:center;max-width:380px;width:90%;
  }
  .modal-content h3{margin-bottom:20px;color:#b284d1;font-size:1.8em;}
  .modal-content input{
    width:100%;padding:16px 20px;border:none;border-radius:16px;
    background:rgba(255,255,255,0.8);font-size:16px;margin-bottom:20px;
    backdrop-filter:blur(5px);
  }
  .modal-btn{
    padding:12px 30px;background:var(--primary);color:white;border:none;border-radius:30px;
    cursor:pointer;font-weight:bold;transition:all .3s;
  }
  .modal-btn:hover{transform:scale(1.05);}
  .shake{animation:shake 0.5s;}
  @keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-8px)}20%,40%,60%,80%{transform:translateX(8px)}}
</style>
</head>
<body>
<div id="particles"></div>
<h1>çˆ±ä¸½ä¸åº­é™¢</h1>
<p class="subtitle">Alice's Garden Â· æ¢¦å¹»ç›¸å†Œï¼ˆé˜²ç›—ç‰ˆé¢„è§ˆæ¨¡å¼ï¼‰</p>
<div class="tabs" id="level1-tabs"></div>
<div class="tabs" id="level2-tabs" style="display:none;"></div>
<div class="tabs" id="level3-tabs" style="display:none;"></div>
<div class="stats" id="stats">åŠ è½½ä¸­...</div>
<div id="gallery"></div>
<div id="overlay">
  <div class="close-btn" onclick="closePreview()">X</div>
  <iframe id="drivePreview" src="" allow="fullscreen"></iframe>
</div>

<!-- Unlock R18 æŒ‰é’® -->
<button id="unlockR18Btn" onclick="openR18Modal()">Unlock R18 ğŸ”“</button>

<!-- R18 å¯†ç å¼¹çª— -->
<div id="r18Modal">
  <div class="modal-content">
    <h3>ğŸ”’ R18 å†…å®¹è§£é”</h3>
    <p style="color:#9a7bb0;margin-bottom:20px;">è¯·è¾“å…¥è®¿é—®å¯†ç </p>
    <input type="password" id="r18Password" placeholder="å¯†ç ">
    <button class="modal-btn" onclick="checkR18Password()">ç¡®è®¤è§£é”</button>
  </div>
</div>

<div class="admin-bar">
  <button class="admin-btn" onclick="refreshData()">åˆ·æ–°ç›¸å†Œ</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<script>
// ==================== é…ç½®åŒº ====================
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzHKJJH59ZxDC8SP0lYNSPN6UgT_VBjuslqMvrO5TcJr6U7eay66wocyZMqtkqz4pTJ/exec';
const REFRESH_TOKEN = 'AliceGarden_8f3k9xL2mPqR7tVy2025!';
const R18_PASSWORD = 'alicecourtyardr18'; // â† è¿™é‡Œæ˜¯å¯†ç 
// ================================================

let images = [];
let currentPath = [];
let r18Unlocked = false; // å…³é”®ï¼šä¸å­˜æœ¬åœ°ï¼Œæ¯æ¬¡åˆ·æ–°éƒ½ä¸º false

const BATCH_SIZE = 50;
let currentIndex = 0;
let currentFolderImages = [];

// Particles
particlesJS('particles', {
  particles: {
    number: {value:60,density:{enable:true,value_area:800}},
    color: {value:['#d8b8f0','#b284d1','#e6f0fa']},
    shape: {type:'circle'},
    opacity: {value:0.4,random:true},
    size: {value:4,random:true},
    line_linked: {enable:false},
    move: {enable:true,speed:0.8,direction:'none',random:true}
  },
  interactivity: {detect_on:'canvas',events:{resize:true}}
});

// é˜²å³é”®ã€é˜²æ‹–æ‹½
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('dragstart', e => e.preventDefault());

function closePreview() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('drivePreview').src = '';
}
document.getElementById('overlay').onclick = function(e){
  if(e.target === this) closePreview();
};
document.addEventListener('keydown', e => { if(e.key==='Escape') closePreview(); });

// ==================== R18 è§£é”ç›¸å…³å‡½æ•° ====================
function openR18Modal() {
  if (r18Unlocked) return;
  document.getElementById('r18Modal').style.display = 'flex';
  document.getElementById('r18Password').focus();
}
function checkR18Password() {
  const input = document.getElementById('r18Password').value.trim();
  if (input === R18_PASSWORD) {
    r18Unlocked = true;
    document.getElementById('r18Modal').style.display = 'none';
    document.getElementById('unlockR18Btn').textContent = 'R18 å·²è§£é” âœ“';
    document.getElementById('unlockR18Btn').classList.add('unlocked');
    document.getElementById('unlockR18Btn').onclick = null;
    // é‡æ–°æ„å»ºå¯¼èˆªå’Œå†…å®¹
    buildBreadcrumbTabs();
    renderCurrentFolder();
    updateStats();
  } else {
    document.getElementById('r18Password').value = '';
    document.querySelector('.modal-content').classList.add('shake');
    setTimeout(() => document.querySelector('.modal-content').classList.remove('shake'), 500);
  }
}
// å›è½¦æäº¤å¯†ç 
document.getElementById('r18Password').addEventListener('keyup', e => {
  if (e.key === 'Enter') checkR18Password();
});

// ç‚¹å‡»æ¨¡æ€èƒŒæ™¯å…³é—­ï¼ˆå¯é€‰ï¼‰
document.getElementById('r18Modal').addEventListener('click', e => {
  if (e.target === document.getElementById('r18Modal')) {
    document.getElementById('r18Modal').style.display = 'none';
  }
});

// è¿‡æ»¤ R18 å†…å®¹ï¼ˆæœªè§£é”æ—¶å®Œå…¨éšè—ï¼‰
function getVisibleImages() {
  if (r18Unlocked) return images;
  return images.filter(img => !img.folder.includes('/R18/'));
}

// ==================== æ•°æ®åŠ è½½ ====================
async function loadData() {
  try {
    const res = await fetch(WEB_APP_URL);
    const data = await res.json();
    images = data.images || [];
    buildBreadcrumbTabs();
    renderCurrentFolder();
    updateStats();
  } catch (err) {
    document.getElementById('stats').textContent = 'åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢';
  }
}

// ==================== å¯¼èˆªæ ‡ç­¾ ====================
function buildBreadcrumbTabs() {
  const visibleImages = getVisibleImages();
  const paths = [...new Set(visibleImages.map(i => i.folder))];
  const level1 = [...new Set(paths.map(p => p.split('/')[0]))].sort();
  
  const l1 = document.getElementById('level1-tabs');
  const l2 = document.getElementById('level2-tabs');
  const l3 = document.getElementById('level3-tabs');
  l1.innerHTML = ''; l2.innerHTML = ''; l3.innerHTML = '';
  l2.style.display = 'none'; l3.style.display = 'none';

  level1.forEach(folder => {
    const tab = document.createElement('div');
    tab.className = 'tab' + (currentPath[0] === folder ? ' active' : '');
    tab.textContent = folder;
    tab.onclick = () => { currentPath = [folder]; buildBreadcrumbTabs(); renderCurrentFolder(); updateStats(); };
    l1.appendChild(tab);
  });

  if (currentPath.length >= 1) {
    const parent = visibleImages.filter(i => i.folder.startsWith(currentPath[0] + '/'));
    const level2 = [...new Set(parent.map(i => i.folder.split('/').slice(0,2).join('/')))]
                   .filter(p => p !== currentPath[0]).map(p=>p.split('/')[1]);
    if (level2.length > 0) {
      l2.style.display = 'flex';
      level2.forEach(name => {
        const tab = document.createElement('div');
        tab.className = 'tab' + (currentPath[1] === name ? ' active' : '');
        tab.textContent = name;
        tab.onclick = () => { currentPath = [currentPath[0], name]; buildBreadcrumbTabs(); renderCurrentFolder(); updateStats(); };
        l2.appendChild(tab);
      });
    }
  }

  if (currentPath.length >= 2) {
    const prefix = currentPath.slice(0,2).join('/');
    const parent = visibleImages.filter(i => i.folder.startsWith(prefix + '/'));
    const level3 = [...new Set(parent.map(i => i.folder.split('/').slice(0,3).join('/')))]
                   .filter(p => p !== prefix).map(p=>p.split('/')[2]);
    if (level3.length > 0) {
      l3.style.display = 'flex';
      level3.forEach(name => {
        const tab = document.createElement('div');
        tab.className = 'tab' + (currentPath[2] === name ? ' active' : '');
        tab.textContent = name;
        tab.onclick = () => { currentPath = [currentPath[0], currentPath[1], name]; buildBreadcrumbTabs(); renderCurrentFolder(); updateStats(); };
        l3.appendChild(tab);
      });
    }
  }
}

// ==================== åˆ†æ‰¹æ¸²æŸ“ ====================
function renderCurrentFolder() {
  const gallery = document.getElementById('gallery');
  gallery.innerHTML = '';
  currentIndex = 0;

  const visibleImages = getVisibleImages();
  let filtered = visibleImages;
  if (currentPath.length > 0) {
    const prefix = currentPath.join('/');
    filtered = visibleImages.filter(i => i.folder === prefix || i.folder.startsWith(prefix + '/'));
  }
  currentFolderImages = filtered;

  if (currentFolderImages.length === 0) {
    gallery.innerHTML = '<p style="text-align:center;color:#aaa;margin:80px;font-size:1.3em;">ç©ºç©ºå¦‚ä¹Ÿï½</p>';
    document.getElementById('more-btn')?.remove();
    return;
  }
  loadMoreImages();
  createMoreButton();
}

function loadMoreImages() {
  const gallery = document.getElementById('gallery');
  const start = currentIndex;
  const end = Math.min(currentIndex + BATCH_SIZE, currentFolderImages.length);
  currentIndex = end;
  const fragment = document.createDocumentFragment();

  for (let i = start; i < end; i++) {
    const img = currentFolderImages[i];
    const card = document.createElement('div');
    card.className = 'card';
    const image = new Image();
    image.loading = 'lazy';
    image.src = img.thumb;
    image.alt = '';
    image.onload = image.onerror = () => {
      gallery.style.columnCount = '1';
      requestAnimationFrame(() => gallery.style.columnCount = '');
    };
    card.appendChild(image);
    card.onclick = (e) => {
      e.stopPropagation();
      const fileId = img.direct.match(/id=([^&]+)/)[1];
      const previewUrl = `https://drive.google.com/file/d/${fileId}/preview`;
      document.getElementById('drivePreview').src = previewUrl;
      document.getElementById('overlay').style.display = 'flex';
    };
    fragment.appendChild(card);
  }
  gallery.appendChild(fragment);

  if (currentIndex >= currentFolderImages.length) {
    document.getElementById('more-btn')?.remove();
  }

  setTimeout(() => {
    gallery.style.columnCount = '1';
    requestAnimationFrame(() => gallery.style.columnCount = '');
  }, 100);
}

function createMoreButton() {
  let old = document.getElementById('more-btn');
  if (old) old.remove();
  if (currentIndex >= currentFolderImages.length) return;

  const btn = document.createElement('button');
  btn.id = 'more-btn';
  btn.textContent = `MOREï¼ˆå‰©ä½™ ${currentFolderImages.length - currentIndex} å¼ ï¼‰`;
  btn.style.cssText = `
    width: 86%; max-width: 520px; margin: 50px auto; display: block;
    padding: 20px; font-size: 24px; font-weight: bold; border-radius: 16px;
    background: linear-gradient(90deg, #c689d8, #a06cd5); color: white; border: none;
    cursor: pointer; box-shadow: 0 10px 30px rgba(198,137,216,0.4); transition: all 0.3s;
  `;
  btn.onmouseover = () => btn.style.transform = 'translateY(-4px)';
  btn.onmouseout = () => btn.style.transform = '';
  btn.onclick = loadMoreImages;
  document.body.appendChild(btn);
}

function updateStats() {
  const visibleImages = getVisibleImages();
  const totalInFolder = currentPath.length > 0
    ? visibleImages.filter(i => i.folder.startsWith(currentPath.join('/') + (currentPath.length > 0 ? '/' : ''))).length
    : visibleImages.length;

  document.getElementById('stats').textContent =
    `å…± ${visibleImages.length} å¼ ç…§ç‰‡${currentPath.length > 0 ? ` Â· å½“å‰æ–‡ä»¶å¤¹ï¼š${totalInFolder} å¼  Â· å·²åŠ è½½ï¼š${currentIndex} å¼ ` : ''}`;
}

async function refreshData() {
  if (!confirm('ç¡®å®šè¦åˆ·æ–°ç›¸å†Œæ•°æ®å—ï¼Ÿ')) return;
  const btn = event.target;
  btn.disabled = true; btn.textContent = 'åˆ·æ–°ä¸­...';
  try {
    await fetch(`${WEB_APP_URL}?action=refresh&token=${REFRESH_TOKEN}`);
    setTimeout(() => location.reload(), 3000);
  } catch (e) {
    alert('åˆ·æ–°å¤±è´¥');
    btn.disabled = false;
    btn.textContent = 'åˆ·æ–°ç›¸å†Œ';
  }
}

loadData();
</script>
</body>
</html>
